install.packages("readr")
install.packages("sf")
install.packages("dplyr")
install.packages("tidyr")
install.packages("ggplot2")
install.packages("patchwork")
install.packages("corrplot")

library(readr)
library(sf)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(corrplot)

file_path <- "/Users/farihasyed/Downloads/New_York_City_s_Flood_Vulnerability_Index.csv"
dataset <- read_csv(file_path)

str(dataset)
head(dataset)
column_names <- colnames(dataset)
print(column_names)

# Convert FVI_storm_surge_present 
print(unique(dataset$FVI_storm_surge_present))
dataset$FVI_storm_surge_present <- as.numeric(dataset$FVI_storm_surge_present)


dataset_sf <- st_as_sf(dataset, wkt = "the_geom", crs = 4326)

# Plot flood vulnerability index 
nyc_map <- ggplot() + 
  geom_sf(data = dataset_sf, aes(fill = factor(FVI_storm_surge_present)), color = NA) + 
  scale_fill_viridis_d(option = "plasma", name = "Flood Vulnerability Index\n(Current Storm Surge)") + 
  theme_minimal() + 
  labs(
    title = "Flood Vulnerability Distribution in New York City", 
    subtitle = "Based on Current Storm Surge Scenario", 
    caption = "Data source: NYC Flood Vulnerability Index"
  ) + 
  theme(
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5), 
    plot.subtitle = element_text(hjust = 0.5)
  )
print(nyc_map)


print(class(dataset_sf$GEOID))
print(head(dataset_sf$GEOID))
dataset_sf$GEOID <- as.character(dataset_sf$GEOID)

# Summarize average FVI by borough
borough_summary <- dataset_sf %>% 
  mutate(
    Borough = case_when(
      substr(GEOID, 1, 5) == "36005" ~ "Bronx",
      substr(GEOID, 1, 5) == "36047" ~ "Brooklyn",
      substr(GEOID, 1, 5) == "36061" ~ "Manhattan",
      substr(GEOID, 1, 5) == "36081" ~ "Queens",
      substr(GEOID, 1, 5) == "36085" ~ "Staten Island",
      TRUE ~ "Unknown"
    )
  ) %>% 
  group_by(Borough) %>% 
  summarize(Avg_FVI = mean(FVI_storm_surge_present, na.rm = TRUE)) %>% 
  arrange(desc(Avg_FVI))
print(borough_summary)

# Plot average FVI by borough
borough_plot <- ggplot(borough_summary, aes(x = reorder(Borough, -Avg_FVI), y = Avg_FVI)) + 
  geom_bar(stat = "identity", fill = "deeppink") + 
  theme_minimal() + 
  labs(
    title = "Average Flood Vulnerability Index by NYC Borough", 
    x = "Borough", 
    y = "Average FVI (Current Storm Surge)"
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(borough_plot)

# Analyze flood vulnerability across different scenarios
flood_scenarios <- dataset_sf %>% 
  select(GEOID, FSHRI, FVI_storm_surge_present, FVI_storm_surge_2050s, FVI_storm_surge_2080s, FVI_tidal_2020s, FVI_tidal_2050s, FVI_tidal_2080s) %>% 
  pivot_longer(cols = starts_with("FVI"), names_to = "Scenario", values_to = "FVI")

# Correlation analysis
correlations <- flood_scenarios %>% 
  group_by(Scenario) %>% 
  summarise(Correlation = cor(FSHRI, FVI, use = "complete.obs"))
print(correlations)

# SP FSHRI vs FVI
scatter_plot <- ggplot(flood_scenarios, aes(x = FSHRI, y = FVI, color = Scenario)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(~ Scenario, scales = "free_y") + 
  theme_minimal() + 
  labs(
    title = "Relationship between FSHRI and FVI across different scenarios", 
    x = "Flood Susceptibility to Harm and Recovery Index (FSHRI)", 
    y = "Flood Vulnerability Index (FVI)"
  )
print(scatter_plot)

# Summary stats
summary_stats <- flood_scenarios %>% 
  group_by(Scenario) %>% 
  summarise(
    Mean_FVI = mean(FVI, na.rm = TRUE),
    Median_FVI = median(FVI, na.rm = TRUE),
    SD_FVI = sd(FVI, na.rm = TRUE)
  )
print(summary_stats)

# Box plot of FVI 
box_plot <- ggplot(flood_scenarios, aes(x = Scenario, y = FVI, fill = Scenario)) + 
  geom_boxplot() + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(
    title = "Distribution of FVI across different scenarios", 
    x = "Scenario", 
    y = "Flood Vulnerability Index (FVI)"
  )
print(box_plot)

# Analyze flood trends over time
flood_trends <- dataset_sf %>% 
  select(GEOID, FVI_storm_surge_present, FVI_storm_surge_2050s, FVI_storm_surge_2080s, FVI_tidal_2020s, FVI_tidal_2050s, FVI_tidal_2080s) %>% 
  pivot_longer(cols = -GEOID, names_to = c("Flood_Type", "Year"), names_pattern = "FVI_(.)_(.)", values_to = "FVI")
flood_trends$Year <- factor(flood_trends$Year, levels = c("present", "2020s", "2050s", "2080s"), labels = c("Present", "2020s", "2050s", "2080s"))

# Summary statistics 
summary_stats <- flood_trends %>% 
  group_by(Flood_Type, Year) %>% 
  summarise(
    Mean_FVI = mean(FVI, na.rm = TRUE),
    Median_FVI = median(FVI, na.rm = TRUE),
    SD_FVI = sd(FVI, na.rm = TRUE)
  )
print(summary_stats)

# Line plot 
line_plot <- ggplot(summary_stats, aes(x = Year, y = Mean_FVI, color = Flood_Type, group = Flood_Type)) + 
  geom_line(size = 1) + 
  geom_point(size = 3) + 
  theme_minimal() + 
  labs(
    title = "Temporal Trends in Flood Vulnerability", 
    x = "Year", 
    y = "Mean Flood Vulnerability Index (FVI)", 
    color = "Flood Type"
  ) + 
  theme(legend.position = "bottom")
print(line_plot)

# Box plot of FVI 
box_plot <- ggplot(flood_trends, aes(x = Year, y = FVI, fill = Flood_Type)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(
    title = "Distribution of Flood Vulnerability Index Over Time", 
    x = "Year", 
    y = "Flood Vulnerability Index (FVI)", 
    fill = "Flood Type"
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom")
print(box_plot)

# Percentage change from baseline (present/2020s) to 2080s
percent_change <- flood_trends %>% 
  group_by(Flood_Type, GEOID) %>% 
  summarise(
    Baseline = first(FVI), 
    End_2080s = last(FVI), 
    Percent_Change = (End_2080s - Baseline) / Baseline * 100
  ) %>% 
  group_by(Flood_Type) %>% 
  summarise(
    Mean_Percent_Change = mean(Percent_Change, na.rm = TRUE), 
    Median_Percent_Change = median(Percent_Change, na.rm = TRUE)
  )
print(percent_change)

# Socio-economic indicators and FVI scenarios
socio_economic_indicators <- c("FSHRI") # Add other relevant column names here
fvi_scenarios <- c("FVI_storm_surge_present", "FVI_storm_surge_2050s", "FVI_storm_surge_2080s", "FVI_tidal_2020s", "FVI_tidal_2050s", "FVI_tidal_2080s")

calculate_correlations
